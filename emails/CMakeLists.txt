set(EMAIL_TEMPLATE_INPUT_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/src/emails")
set(EMAIL_TEMPLATE_HTML_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/emails/output/html")
set(EMAIL_TEMPLATE_TXT_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/emails/output/html")
file(MAKE_DIRECTORY ${EMAIL_TEMPLATE_HTML_OUTPUT_DIRECTORY})
file(MAKE_DIRECTORY ${EMAIL_TEMPLATE_TXT_OUTPUT_DIRECTORY})

set(EMAIL_IN_TREE_OUTPUT "${CMAKE_SOURCE_DIR}/server/communication/email_templates")

# WARNING: This does not exclude any spec or story files.
file(GLOB_RECURSE EMAIL_TEMPLATE_INPUTS "${EMAIL_TEMPLATE_INPUT_DIRECTORY}/*.tsx")

set(HTML_EMAIL_TEMPLATES "${EMAIL_TEMPLATE_INPUTS}")
list(TRANSFORM HTML_EMAIL_TEMPLATES REPLACE "${EMAIL_TEMPLATE_INPUT_DIRECTORY}" "${EMAIL_IN_TREE_OUTPUT}")
list(TRANSFORM HTML_EMAIL_TEMPLATES REPLACE ".tsx" ".html")

set(TEXT_EMAIL_TEMPLATES "${EMAIL_TEMPLATE_INPUTS}")
list(TRANSFORM TEXT_EMAIL_TEMPLATES REPLACE "${EMAIL_TEMPLATE_INPUT_DIRECTORY}" "${EMAIL_IN_TREE_OUTPUT}")
list(TRANSFORM TEXT_EMAIL_TEMPLATES REPLACE ".tsx" ".txt")

add_custom_command(
  OUTPUT ${HTML_EMAIL_TEMPLATES}
  BYPRODUCTS ${HTML_EMAIL_TEMPLATES}
  COMMAND ${REACT_EMAIL_EXECUTABLE} export --dir src/emails --outDir ${EMAIL_TEMPLATE_HTML_OUTPUT_DIRECTORY}
  COMMAND ${CMAKE_COMMAND} -E copy ${EMAIL_TEMPLATE_HTML_OUTPUT_DIRECTORY}/* ${EMAIL_IN_TREE_OUTPUT}
  COMMENT "Building HTML email templates from React"
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
  DEPENDS
    tools.react-email
    ${EMAIL_TEMPLATE_INPUTS}
)

add_custom_command(
  OUTPUT ${TEXT_EMAIL_TEMPLATES}
  BYPRODUCTS ${TEXT_EMAIL_TEMPLATES}
  COMMAND ${REACT_EMAIL_EXECUTABLE} export --plainText --dir src/emails --outDir ${EMAIL_TEMPLATE_TXT_OUTPUT_DIRECTORY}
  COMMAND ${CMAKE_COMMAND} -E copy ${EMAIL_TEMPLATE_TXT_OUTPUT_DIRECTORY}/* ${EMAIL_IN_TREE_OUTPUT}
  COMMENT "Building TXT email templates from React"
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
  DEPENDS
    tools.react-email
    ${EMAIL_TEMPLATE_INPUTS}
)

add_custom_target(
  build.email
  COMMAND exit
  DEPENDS
    ${HTML_EMAIL_TEMPLATES}
    ${TEXT_EMAIL_TEMPLATES}
)

add_custom_target(
  development.email
  COMMENT "Running the local development tools for email templates"
  COMMAND ${REACT_EMAIL_EXECUTABLE} dev --dir src/emails
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
  DEPENDS
    tools.react-email
)

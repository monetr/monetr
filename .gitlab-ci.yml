stages:
  - Test
  - Dry
  - Deploy

Test Go:
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
      when: never
  stage: Test
  image: ghcr.io/monetr/build-containers/golang:1.19.4
  variables:
    POSTGRES_HOST: postgres
    POSTGRES_PASSWORD: "password"
    POSTGRES_USER: api-testing
    POSTGRES_DB: test-db
    POSTGRES_HOST_AUTH_METHOD: trust
  tags:
    - monetr:shared
  services:
    - postgres:13
  script:
    - make test-go

Dry:
  stage: Dry
  image: ghcr.io/monetr/build-containers/ubuntu:20.04-106-g51b5b23
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
      when: always
  environment:
    deployment_tier: staging
    action: prepare
    name: Staging
    url: https://my.monetr.dev
    kubernetes:
      namespace: monetr-staging
#  only
#    refs:
#      - main
  tags:
    - env:staging
  variables:
    ENVIRONMENT: my.monetr.dev
  script:
    - make dry

Deploy:
  stage: Deploy
  image: ghcr.io/monetr/build-containers/ubuntu:20.04-106-g51b5b23
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
      when: always
  environment:
    deployment_tier: staging
    name: Staging
    url: https://my.monetr.dev
    kubernetes:
      namespace: monetr-staging
#  only:
#    variables:
#      - $CI_PIPELINE_SOURCE == "trigger"
#    refs:
#      - main
  tags:
    - env:staging
  variables:
    ENVIRONMENT: my.monetr.dev
  script:
    - make deploy
